<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Good to Go</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
</head>
<body class="dashboard-body">
    <!-- Header -->
    <header class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <img src="assets/logo.svg" alt="Good to Go" width="40" height="40" class="me-2">
                <span class="fw-bold">Good to Go</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto">
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-wallet me-1"></i> Wallet: ₹<span id="walletAmount">0</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#walletModal">Add Money</a></li>
                        </ul>
                    </div>
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-gift me-1"></i> Refer & Earn
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#referralModal">Get ₹100 Off</a></li>
                        </ul>
                    </div>
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-cog me-1"></i> Settings
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#themeModal">Theme</a></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#helpModal">Help</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="signOutBtn">Sign Out</a></li>
                            <li><a class="dropdown-item text-danger" href="#" id="deleteAccountBtn">Delete Account</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container py-4">
        <!-- User Profile Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="profile-card">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <div class="profile-avatar">
                                <img id="profileAvatar" src="assets/male-avatar2.svg" alt="Profile" width="80" height="80">
                            </div>
                        </div>
                        <div class="col">
                            <h3 class="mb-1" id="userName">Loading...</h3>
                            <p class="text-muted mb-1">SAP ID: <span id="userSapId">Loading...</span></p>
                            <p class="text-muted mb-1">Email: <span id="userEmail">Loading...</span></p>
                            <p class="text-muted mb-0">Phone: <span id="userPhone">Loading...</span></p>
                        </div>
                        <div class="col-auto">
                            <div class="referral-code">
                                <small class="text-muted">Referral Code</small>
                                <div class="fw-bold" id="referralCode">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trip Section -->
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="display-6 fw-bold text-primary">Upcoming Weekend Trips</h2>
                    <div class="trip-filter">
                        <button class="btn btn-outline-primary active" data-filter="all">All Trips</button>
                        <button class="btn btn-outline-primary" data-filter="adventure">Adventure</button>
                        <button class="btn btn-outline-primary" data-filter="spiritual">Spiritual</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trip Cards -->
        <div class="row g-4" id="tripsContainer">
            <!-- Trip cards will be dynamically loaded here -->
        </div>

        <!-- My Trips Section -->
        <div class="row mt-5">
            <div class="col-12">
                <h2 class="display-6 fw-bold text-primary mb-4">My Trips</h2>
                <div class="row g-4" id="myTripsContainer">
                    <!-- User's booked trips will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Wallet Modal -->
    <div class="modal fade" id="walletModal" tabindex="-1" aria-labelledby="walletModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="walletModalLabel">Add Money to Wallet</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="walletForm">
                        <div class="mb-3">
                            <label for="amount" class="form-label">Amount (₹)</label>
                            <input type="number" class="form-control" id="amount" name="amount" min="100" max="10000" required>
                        </div>
                        <div class="mb-3">
                            <label for="paymentMethod" class="form-label">Payment Method</label>
                            <div class="payment-methods">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="method" id="scanner" value="QR Scanner" checked>
                                    <label class="form-check-label" for="scanner">
                                        <i class="fas fa-qrcode me-2"></i> QR Code Scanner
                                    </label>
                                </div>

                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="method" id="cash" value="Cash">
                                    <label class="form-check-label" for="cash">
                                        <i class="fas fa-money-bill me-2"></i> Cash
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Add Money</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Referral Modal -->
    <div class="modal fade" id="referralModal" tabindex="-1" aria-labelledby="referralModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="referralModalLabel">Refer Friends & Get ₹100 Off</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="referral-offer">
                        <i class="fas fa-gift fa-4x text-primary mb-3"></i>
                        <h4>Invite Your Friends!</h4>
                        <p class="text-muted">Share your referral code and get ₹100 off on your next trip when they sign up.</p>
                        
                        <div class="referral-code-share mt-4">
                            <label class="form-label">Your Referral Code:</label>
                            <div class="input-group">
                                <input type="text" class="form-control text-center fw-bold" id="shareReferralCode" readonly>
                                <button class="btn btn-outline-secondary" type="button" id="copyReferralCode">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>

                        <div class="share-buttons mt-3">
                            <button class="btn btn-success me-2" onclick="shareOnWhatsApp()">
                                <i class="fab fa-whatsapp me-1"></i> WhatsApp
                            </button>
                            <button class="btn btn-info" onclick="shareOnTelegram()">
                                <i class="fab fa-telegram me-1"></i> Telegram
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Theme Modal -->
    <div class="modal fade" id="themeModal" tabindex="-1" aria-labelledby="themeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="themeModalLabel">Theme Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="theme-options">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="theme" id="lightTheme" value="light" checked>
                            <label class="form-check-label" for="lightTheme">
                                <i class="fas fa-sun me-2"></i> Light Theme
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="theme" id="darkTheme" value="dark">
                            <label class="form-check-label" for="darkTheme">
                                <i class="fas fa-moon me-2"></i> Dark Theme
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="theme" id="autoTheme" value="auto">
                            <label class="form-check-label" for="autoTheme">
                                <i class="fas fa-adjust me-2"></i> Auto (System)
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="applyTheme">Apply Theme</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="helpModalLabel">Help & Support</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="help-content">
                        <h6>Contact Us</h6>
                        <div class="contact-info">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-envelope text-primary me-2"></i>
                                <span>support@goodtogo.com</span>
                            </div>
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-phone text-primary me-2"></i>
                                <span>+91 9876543210</span>
                            </div>
                        </div>

                        <h6>Quick Help</h6>
                        <div class="help-topics">
                            <div class="help-topic">
                                <strong>How to book a trip?</strong>
                                <p class="text-muted small">Select your preferred trip from the list and click 'Book Now'. Ensure you have sufficient wallet balance.</p>
                            </div>
                            <div class="help-topic">
                                <strong>Cancellation Policy</strong>
                                <p class="text-muted small">Free cancellation up to 48 hours before the trip. 50% refund for cancellations within 48 hours.</p>
                            </div>
                            <div class="help-topic">
                                <strong>Referral Program</strong>
                                <p class="text-muted small">Share your referral code with friends. Get ₹100 off when they complete their first booking.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Modal -->
    <div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bookingModalLabel">Book Your Trip</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="trip-booking-details">
                        <h6 id="bookingTripName">Trip Name</h6>
                        <p class="text-muted" id="bookingTripDate">Date</p>
                        <div class="pricing-info mb-3">
                            <span class="h4 text-success" id="bookingTripPrice">₹599</span>
                        </div>
                        <div class="wallet-info mb-3">
                            <p class="mb-1">Your Wallet Balance: <strong>₹<span id="modalWalletBalance">0</span></strong></p>
                            <div id="insufficientFunds" class="alert alert-warning d-none">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Insufficient wallet balance. Please add money to your wallet first.
                            </div>
                        </div>
                    </div>
                    <div class="booking-options">
                        <p class="mb-3">Choose an option:</p>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-outline-primary" id="talkToHostBtn">
                                <i class="fas fa-comments me-2"></i>
                                Talk About Trip to Host
                            </button>
                            <button type="button" class="btn btn-primary" id="continuePaymentBtn">
                                <i class="fas fa-credit-card me-2"></i>
                                Continue with Payment
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Host Contact Modal -->
    <div class="modal fade" id="hostContactModal" tabindex="-1" aria-labelledby="hostContactModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="hostContactModalLabel">Contact Trip Host</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="host-contact-info">
                        <i class="fas fa-user-circle fa-4x text-primary mb-3"></i>
                        <h5>Trip Coordinator</h5>
                        <p class="text-muted">Get all your questions answered before booking</p>
                        
                        <div class="contact-options mt-4">
                            <div class="d-grid gap-2">
                                <a href="tel:+919876543210" class="btn btn-success">
                                    <i class="fas fa-phone me-2"></i>
                                    Call: +91 9876543210
                                </a>
                                <a href="https://wa.me/919876543210" target="_blank" class="btn btn-success">
                                    <i class="fab fa-whatsapp me-2"></i>
                                    WhatsApp Chat
                                </a>
                                <a href="mailto:trips@goodtogo.com" class="btn btn-outline-primary">
                                    <i class="fas fa-envelope me-2"></i>
                                    Email: trips@goodtogo.com
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Back to Booking</button>
                </div>
            </div>
        </div>
    </div>
<div class="modal fade" id="qrCodeModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Scan to Pay</h5>
            </div>
            <div class="modal-body text-center">
                <p>Scan the QR code below with any UPI app.</p>
                <img src="https://ia601701.us.archive.org/19/items/whats-app-image-2025-08-09-at-23.38.37-8cd-2b-873/WhatsApp%20Image%202025-08-09%20at%2023.38.37_8cd2b873.jpg" alt="Payment QR Code" class="img-fluid mb-3">
                <p class="text-muted">Amount to Pay: <strong>₹<span id="qrAmount">0</span></strong></p>
                <div id="paymentStatus" class="mt-3">
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    Waiting for payment confirmation...
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="cashCollectorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Contact Cash Collector</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-money-bill-wave fa-4x text-primary mb-3"></i>
                <h4>Pay in Cash</h4>
                <p class="text-muted">Please contact the trip coordinator to complete your payment. Your wallet will be updated once they confirm receipt of the cash.</p>
                <div class="d-grid gap-2 mt-4">
                    <a href="tel:+919876543210" class="btn btn-success">
                        <i class="fas fa-phone me-2"></i>
                        Call Coordinator
                    </a>
                    <a href="https://wa.me/919876543210" target="_blank" class="btn btn-success">
                        <i class="fab fa-whatsapp me-2"></i>
                        Chat on WhatsApp
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script>

        // Dashboard-specific JavaScript
        let currentUser = null;
        let currentTripToBook = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadUserProfile();
            loadTrips();
            loadMyTrips();
            setupEventListeners();
        });

// In dashboard.html

async function loadUserProfile() {
    try {
        const response = await fetch(`${API_BASE}/api/profile`, {
            method: 'GET',
            credentials: 'include'
        });

        // ✅ FIX: Check if the response is a 401 Unauthorized error
        if (response.status === 401) {
            throw new Error('Not authenticated');
        }

        if (!response.ok) {
            throw new Error(`Server error: ${response.statusText}`);
        }

        const data = await response.json();
        
        if (data.success) {
            const user = data.user;
            currentUser = user;
            // ... (rest of your user info display logic is here)
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userSapId').textContent = user.sapId;
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userPhone').textContent = user.phone;
            document.getElementById('walletAmount').textContent = user.wallet || 0;
            document.getElementById('referralCode').textContent = user.referralCode;
            document.getElementById('shareReferralCode').value = user.referralCode;
            
            const avatarImg = document.getElementById('profileAvatar');
            avatarImg.src = user.gender === 'female' ? 'assets/female-avatar.svg' : 'assets/male-avatar.svg';
        } else {
            // This case should be rare, but we handle it.
            throw new Error(data.message || 'Failed to load profile.');
        }
    } catch (error) {
        console.error('Error loading profile:', error);
        // ✅ FIX: Instead of redirecting, show an error message on the page.
        document.querySelector('.container').innerHTML = `
            <div class="text-center py-5">
                <h2 class="text-danger">Authentication Failed</h2>
                <p class="text-muted">You need to be logged in to view this page.</p>
                <a href="signin.html" class="btn btn-primary mt-3">Login Now</a>
            </div>
        `;
    }
}


async function loadTrips() {
    console.log("1. Starting to load trips...");
    try {
        const response = await fetch(`${API_BASE}/api/trips`, {
            method: 'GET',
            credentials: 'include'
        });
        
        console.log("2. Received response from server:", response);

        if (!response.ok) {
            console.error("Fetch response was not OK.", response.status, response.statusText);
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const tripsArray = await response.json();
        
        console.log("3. Parsed JSON data:", tripsArray);
        
        if (Array.isArray(tripsArray) && tripsArray.length > 0) {
            console.log("4. Data is a valid array with trips. Calling displayTrips...");
            displayTrips(tripsArray);
        } else {
            console.log("4. Data is either not an array or is empty. Not displaying trips.");
            // Display a message if no trips are found
            document.getElementById('tripsContainer').innerHTML = '<p class="text-center text-muted">No upcoming trips found at the moment.</p>';
        }

    } catch (error) {
        console.error('5. An error occurred in loadTrips:', error);
        document.getElementById('tripsContainer').innerHTML = '<p class="text-center text-danger">Could not load trips. Please try refreshing the page.</p>';
    }
}

        function displayTrips(trips) {
            const container = document.getElementById('tripsContainer');
            container.innerHTML = '';
            
            trips.forEach(trip => {
                const tripCard = createTripCard(trip);
                container.appendChild(tripCard);
            });
        }

// In dashboard.html

// In dashboard.html

function createTripCard(trip) {
    const col = document.createElement('div');
    col.className = 'col-md-6 col-lg-4';

    const discount = Math.round(((trip.originalPrice - trip.salePrice) / trip.originalPrice) * 100);
    const imageUrl = `${API_BASE}${trip.image}`;

    col.innerHTML = `
        <div class="trip-card">
            <div class="trip-image">
                <img src="${imageUrl}" alt="${trip.destination}">
                <div class="trip-badge">
                    <span class="badge bg-success">${discount}% OFF</span>
                </div>
            </div>
            <div class="trip-content">
                <h5 class="trip-title">${trip.destination}</h5>
                <p class="trip-date">
                    <i class="fas fa-calendar me-1"></i> ${new Date(trip.date).toDateString()}
                </p>
                <p class="trip-description">${trip.description}</p>
                <div class="trip-pricing">
                    <span class="original-price">₹${trip.originalPrice}</span>
                    <span class="sale-price">₹${trip.salePrice}</span>
                </div>
                <button class="btn btn-primary w-100 mt-3" data-trip='${JSON.stringify(trip)}' onclick="bookTrip(this)">
                    <i class="fas fa-check me-1"></i> Book Now
                </button>
            </div>
        </div>
    `;

    return col;
}



async function loadMyTrips() {
    try {
        const response = await fetch(`${API_BASE}/api/my-trips`, {
            method: 'GET',
            credentials: 'include' // Include cookies for session management
                });
                const data = await response.json();
                
                if (data.success) {
                    displayMyTrips(data.bookings);
                }
            } catch (error) {
                console.error('Error loading my trips:', error);
            }
        }

        function displayMyTrips(bookings) {
            const container = document.getElementById('myTripsContainer');
            
            if (bookings.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="fas fa-suitcase-rolling fa-4x text-muted mb-3"></i>
                            <h4 class="text-muted">No trips booked yet</h4>
                            <p class="text-muted">Book your first adventure above!</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            bookings.forEach(booking => {
                const bookingCard = createBookingCard(booking);
                container.appendChild(bookingCard);
            });
        }

        function createBookingCard(booking) {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4';
            
            const bookingDate = new Date(booking.bookedAt).toLocaleDateString('en-IN');
            
            col.innerHTML = `
                <div class="trip-card">
                    <div class="trip-content">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="trip-title">${booking.destination}</h5>
                            <span class="badge bg-success">${booking.status}</span>
                        </div>
                        <p class="text-muted mb-2">
                            <i class="fas fa-calendar me-1"></i> Booked on ${bookingDate}
                        </p>
                        <p class="text-muted mb-3">
                            <i class="fas fa-money-bill me-1"></i> Amount: ₹${booking.amount}
                        </p>
                        <button class="btn btn-outline-primary w-100">
                            <i class="fas fa-eye me-1"></i> View Details
                        </button>
                    </div>
                </div>
            `;
            
            return col;
        }

// ✅ PASTE THIS NEW CODE IN ITS PLACE
function bookTrip(buttonElement) {
    // Read trip data directly from the button's data-trip attribute
    const tripData = JSON.parse(buttonElement.getAttribute('data-trip'));

    if (tripData) {
        currentTripToBook = tripData;
        showBookingModal(tripData);
    } else {
        console.error('Could not find trip data on the button.');
        alert('An error occurred. Please try again.');
    }
}

        function showBookingModal(trip) {
            // Update modal content
            document.getElementById('bookingTripName').textContent = trip.destination;
            document.getElementById('bookingTripDate').textContent = trip.date;
            document.getElementById('bookingTripPrice').textContent = `₹${trip.salePrice}`;
            document.getElementById('modalWalletBalance').textContent = currentUser.wallet || 0;
            
            // Check if user has sufficient funds
            const insufficientFunds = document.getElementById('insufficientFunds');
            const continueBtn = document.getElementById('continuePaymentBtn');
            
            if (currentUser.wallet < trip.salePrice) {
                insufficientFunds.classList.remove('d-none');
                continueBtn.disabled = true;
                continueBtn.innerHTML = '<i class="fas fa-plus me-2"></i>Add Money First';
            } else {
                insufficientFunds.classList.add('d-none');
                continueBtn.disabled = false;
                continueBtn.innerHTML = '<i class="fas fa-credit-card me-2"></i>Continue with Payment';
            }
            
            // Show modal
            const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
            bookingModal.show();
        }

        function setupEventListeners() {
            // Wallet form
            document.getElementById('walletForm').addEventListener('submit', handleWalletAdd);
            
            // Copy referral code
            document.getElementById('copyReferralCode').addEventListener('click', copyReferralCode);
            
            // Theme settings
            document.getElementById('applyTheme').addEventListener('click', applyTheme);
            
            // Sign out
            document.getElementById('signOutBtn').addEventListener('click', signOut);
            
            // Delete account
            document.getElementById('deleteAccountBtn').addEventListener('click', deleteAccount);
            
            // Trip filter buttons
            setupTripFilters();
            
            // Booking modal events
            document.getElementById('talkToHostBtn').addEventListener('click', () => {
                const bookingModal = bootstrap.Modal.getInstance(document.getElementById('bookingModal'));
                bookingModal.hide();
                const hostModal = new bootstrap.Modal(document.getElementById('hostContactModal'));
                hostModal.show();
            });
            
            document.getElementById('continuePaymentBtn').addEventListener('click', handlePayment);
        }

        function setupTripFilters() {
            const filterButtons = document.querySelectorAll('[data-filter]');
            filterButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    // Remove active class from all buttons
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    // Add active class to clicked button
                    e.target.classList.add('active');
                    
                    const filter = e.target.dataset.filter;
                    filterTrips(filter);
                });
            });
        }

        function filterTrips(category) {
            const allTripCards = document.querySelectorAll('#tripsContainer .col-md-6');
            
            allTripCards.forEach(card => {
                const tripCard = card.querySelector('.trip-card');
                const tripTitle = tripCard.querySelector('.trip-title').textContent.toLowerCase();
                
                if (category === 'all') {
                    card.style.display = 'block';
                } else if (category === 'adventure') {
                    // Show adventure trips (Rishikesh, Mussoorie)
                    if (tripTitle.includes('rishikesh') || tripTitle.includes('mussoorie') || 
                        tripTitle.includes('adventure') || tripTitle.includes('maldevta')) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                } else if (category === 'spiritual') {
                    // Show spiritual trips (Haridwar)
                    if (tripTitle.includes('haridwar') || tripTitle.includes('spiritual')) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                }
            });
        }

        async function handlePayment() {
            if (!currentTripToBook || !currentUser) return;
            
            const continueBtn = document.getElementById('continuePaymentBtn');
            const originalText = continueBtn.innerHTML;
            continueBtn.disabled = true;
            continueBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
            
            try {
                const response = await fetch(`${API_BASE}/api/book-trip`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tripId: currentTripToBook.id
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update wallet balance
                    currentUser.wallet = data.newWalletBalance;
                    document.getElementById('walletAmount').textContent = data.newWalletBalance;
                    
                    // Close modal
                    const bookingModal = bootstrap.Modal.getInstance(document.getElementById('bookingModal'));
                    bookingModal.hide();
                    
                    // Show success message
                    GoodToGo.showAlert('success', data.message);
                    
                    // Reload my trips
                    loadMyTrips();
                } else {
                    if (data.requiredAmount && data.currentBalance !== undefined) {
                        GoodToGo.showAlert('warning', data.message);
                    } else {
                        GoodToGo.showAlert('danger', data.message || 'Booking failed. Please try again.');
                    }
                }
            } catch (error) {
                console.error('Booking error:', error);
                GoodToGo.showAlert('danger', 'Network error. Please try again.');
            } finally {
                continueBtn.disabled = false;
                continueBtn.innerHTML = originalText;
            }
        }

// In dashboard.html script

let paymentCheckInterval = null; // Variable to hold our interval

async function handleWalletAdd(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const amount = formData.get('amount');
    const method = formData.get('method');

    // Step 1: Initiate the transaction with the backend
    try {
        const response = await fetch(`${API_BASE}/api/wallet/initiate-transaction`, {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount, method: method === 'QR Scanner' ? 'QR' : 'Cash' })
        });

        const data = await response.json();

        if (data.success) {
            const transactionId = data.transactionId;
            bootstrap.Modal.getInstance(document.getElementById('walletModal')).hide();
            
            // Step 2: Show the correct modal based on the payment method
            if (method === 'QR Scanner') {
                document.getElementById('qrAmount').textContent = amount;
                const qrModal = new bootstrap.Modal(document.getElementById('qrCodeModal'));
                qrModal.show();
                // Start checking for payment confirmation
                checkPaymentStatus(transactionId);
            } else if (method === 'Cash') {
                const cashModal = new bootstrap.Modal(document.getElementById('cashCollectorModal'));
                cashModal.show();
            }
        } else {
            showAlert('error', data.message);
        }
    } catch (error) {
        console.error('Error initiating transaction:', error);
        showAlert('error', 'Could not start the transaction. Please try again.');
    }
}

function checkPaymentStatus(transactionId) {
    // Clear any previous interval
    if (paymentCheckInterval) {
        clearInterval(paymentCheckInterval);
    }

    // Check the status every 3 seconds
    paymentCheckInterval = setInterval(async () => {
        try {
            const response = await fetch(`${API_BASE}/api/wallet/payment-status/${transactionId}`, {
                method: 'GET',
                credentials: 'include'
            });
            const data = await response.json();

            if (data.success && data.status === 'completed') {
                // Payment is confirmed!
                clearInterval(paymentCheckInterval);
                const qrModalEl = document.getElementById('qrCodeModal');
                const qrModal = bootstrap.Modal.getInstance(qrModalEl);
                if(qrModal) {
                    qrModal.hide();
                }
                showAlert('success', 'Payment successful! Your wallet has been updated.');
                // Reload user profile to show new balance
                loadUserProfile();
            }
            // If status is still 'pending', do nothing and let the interval run again.
        } catch (error) {
            console.error('Error checking payment status:', error);
            clearInterval(paymentCheckInterval); // Stop on error
        }
    }, 3000); // 3000ms = 3 seconds
}

        function copyReferralCode() {
            const codeInput = document.getElementById('shareReferralCode');
            codeInput.select();
            document.execCommand('copy');
            showAlert('success', 'Referral code copied to clipboard!');
        }

        function shareOnWhatsApp() {
            const code = document.getElementById('shareReferralCode').value;
            const message = `Hey! Join me on Good to Go - the best travel app for UPES students! Use my referral code ${code} and get amazing discounts on Uttarakhand trips. Download now!`;
            window.open(`https://wa.me/?text=${encodeURIComponent(message)}`);
        }

        function shareOnTelegram() {
            const code = document.getElementById('shareReferralCode').value;
            const message = `Join Good to Go with my referral code ${code} and explore Uttarakhand with fellow UPES students!`;
            window.open(`https://t.me/share/url?url=goodtogo.com&text=${encodeURIComponent(message)}`);
        }

        function applyTheme() {
            const selectedTheme = document.querySelector('input[name="theme"]:checked').value;
            localStorage.setItem('theme', selectedTheme);
            
            if (selectedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
            } else if (selectedTheme === 'light') {
                document.body.removeAttribute('data-theme');
            } else {
                // Auto theme - detect system preference
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.setAttribute('data-theme', 'dark');
                } else {
                    document.body.removeAttribute('data-theme');
                }
            }
            
            bootstrap.Modal.getInstance(document.getElementById('themeModal')).hide();
            showAlert('success', 'Theme applied successfully!');
        }

        async function signOut() {
            try {
                const response = await fetch(`${API_BASE}/api/logout`, { method: 'POST', credentials: 'include' });
                const data = await response.json();
                
                if (data.success) {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Error signing out:', error);
            }
        }

        async function deleteAccount() {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                try {
                    const response = await fetch(`${API_BASE}/api/account`, { method: 'DELETE', credentials: 'include' });
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('Account deleted successfully.');
                        window.location.href = '/';
                    } else {
                        showAlert('error', data.message);
                    }
                } catch (error) {
                    console.error('Error deleting account:', error);
                    showAlert('error', 'Failed to delete account. Please try again.');
                }
            }
        }

        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html>
